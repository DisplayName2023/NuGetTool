@page "/"
@implements IDisposable
@using NuGetTool.Core
@using System.IO
@using System.Linq
@using NuGetTool.Web.Services
@inject PackageService PackageService
@inject MetadataService MetadataService
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>NuGet Tool - Dashboard</PageTitle>

<div class="container-fluid mt-2">
    <div class="row">
        <div class="col-lg-5">
            <div class="premium-card">
                <h5 class="mb-2"><i class="bi bi-box-seam me-2"></i>Package Configuration</h5>
                
                <div class="form-group">
                    <label>Package ID</label>
                    <input type="text" @bind="Metadata.Id" class="form-control-premium" placeholder="e.g. MyAwesomePackage" />
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Version</label>
                            <input type="text" @bind="Metadata.Version" class="form-control-premium" placeholder="1.0.0" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Authors</label>
                            <input type="text" @bind="Metadata.Authors" class="form-control-premium" placeholder="Author Name" />
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea @bind="Metadata.Description" class="form-control-premium" rows="2" placeholder="Describe your package (defaults to file list if empty)..."></textarea>
                </div>

                <div class="form-group">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="mb-0">Content Files (one per line)</label>
                        <button class="btn btn-sm btn-outline-light" @onclick="TriggerFileSelect">
                            <i class="bi bi-folder2-open me-1"></i>Browse Files...
                        </button>
                    </div>
                    <InputFile OnChange="HandleFileSelection" multiple class="d-none" id="fileInput" />
                    <textarea @bind="ContentFilesRaw" class="form-control-premium" rows="4" placeholder="C:\path\to\file.dll"></textarea>
                </div>

                <hr class="my-2 border-secondary" />

                <div class="form-group">
                    <label>NuGet Source URL (e.g. Repository URL)</label>
                    <input type="text" @bind="SourceUrl" class="form-control-premium" placeholder="https://api.nuget.org/v3/index.json" />
                    <small class="text-secondary">Provide the full URL for non-nuget.org sources.</small>
                </div>

                <div class="form-group">
                    <label>Package Source Key (for nuget.config)</label>
                    <input type="text" @bind="PackageSourceKey" class="form-control-premium" placeholder="e.g. gitlab" />
                </div>

                <div class="form-group">
                    <label>API Key (for nuget.org)</label>
                    <input type="password" @bind="ApiKey" class="form-control-premium" placeholder="Enter API Key" />
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Username (for GitLab/Other)</label>
                            <input type="text" @bind="UserName" class="form-control-premium" placeholder="Username" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" @bind="Password" class="form-control-premium" placeholder="Password" />
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Target Type</label>
                    <div class="d-flex gap-3 mt-2">
                        <label class="d-flex align-items-center gap-2" style="cursor:pointer">
                            <input type="radio" name="targetType" checked="@(!IsNuspec)" @onclick="() => IsNuspec = false" /> .csproj
                        </label>
                        <label class="d-flex align-items-center gap-2" style="cursor:pointer">
                            <input type="radio" name="targetType" checked="@IsNuspec" @onclick="() => IsNuspec = true" /> .nuspec
                        </label>
                    </div>
                </div>

                <div class="d-grid gap-1 mt-2">
                    <button class="btn btn-primary-premium" @onclick="GenerateProject" disabled="@IsProcessing">
                        @if (IsProcessing) { <span class="spinner-border spinner-border-sm me-2"></span> }
                        Generate & Build Package
                    </button>
                    <button class="btn btn-primary-premium" style="background: linear-gradient(135deg, #10b981, #059669)" @onclick="UploadPackage" disabled="@IsProcessing">
                        @if (IsProcessing) { <span class="spinner-border spinner-border-sm me-2"></span> }
                        Upload to NuGet
                    </button>
                    @if (IsProcessing)
                    {
                        <button class="btn btn-danger w-100 mt-2" @onclick="CancelOperation">
                            <i class="bi bi-x-circle me-2"></i>Cancel Operation
                        </button>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="premium-card h-100 d-flex flex-column">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0"><i class="bi bi-terminal me-2"></i>Process Logs</h5>
                    <button class="btn btn-sm btn-outline-light" @onclick="ClearLogs">Clear</button>
                </div>
                
                <div class="terminal-log flex-grow-1" id="terminal-container">
                    @foreach (var log in Logs)
                    {
                        <div class="terminal-line">@log</div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private PackageMetadata Metadata = new();
    private string ContentFilesRaw = string.Empty;
    private string SourceUrl = "https://api.nuget.org/v3/index.json";
    private string PackageSourceKey = "gitlab";
    private string? ApiKey;
    private string? UserName;
    private string? Password;
    private bool IsNuspec = false;
    private bool IsProcessing = false;
    private List<string> Logs = new();

    protected override void OnInitialized()
    {
        PackageService.OnLog += HandleLog;

        // Initialize from environment variables
        ApiKey = Environment.GetEnvironmentVariable("NUGET_ORG_API_KEY");
        UserName = Environment.GetEnvironmentVariable("GITLAB_PACKAGE_REGISTRY_USERNAME");
        Password = Environment.GetEnvironmentVariable("GITLAB_PACKAGE_REGISTRY_PASSWORD");
        
        var envSourceUrl = Environment.GetEnvironmentVariable("GITLAB_PACKAGE_REGISTRY_URL");
        if (!string.IsNullOrWhiteSpace(envSourceUrl))
        {
            SourceUrl = envSourceUrl;
        }

        var envSourceKey = Environment.GetEnvironmentVariable("GITLAB_PACKAGE_REGISTRY_SOURCE_KEY");
        if (!string.IsNullOrWhiteSpace(envSourceKey))
        {
            PackageSourceKey = envSourceKey;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var savedUrl = await JS.InvokeAsync<string>("localStorage.getItem", "nuget-source-url");
                if (!string.IsNullOrWhiteSpace(savedUrl))
                {
                    SourceUrl = savedUrl;
                    StateHasChanged();
                }
            }
            catch { }
        }
    }

    private void HandleLog(string message)
    {
        InvokeAsync(() =>
        {
            Logs.Add($"[{DateTime.Now:HH:mm:ss}] {message}");
            StateHasChanged();
            ScrollToBottom();
        });
    }

    private async void ScrollToBottom()
    {
        try 
        {
            await JS.InvokeVoidAsync("eval", "var el = document.getElementById('terminal-container'); if(el) el.scrollTop = el.scrollHeight;");
        }
        catch { }
    }

    private void ClearLogs() => Logs.Clear();

    private async Task TriggerFileSelect()
    {
        await JS.InvokeVoidAsync("eval", "document.getElementById('fileInput').click()");
    }

    private async Task HandleFileSelection(InputFileChangeEventArgs e)
    {
        var packageId = string.IsNullOrWhiteSpace(Metadata.Id) ? "Unspecified" : Metadata.Id;
        var uploadDir = Path.Combine(Path.GetTempPath(), "NuGetTool", packageId, "uploads");
        Directory.CreateDirectory(uploadDir);

        foreach (var file in e.GetMultipleFiles())
        {
            try
            {
                var filePath = Path.Combine(uploadDir, file.Name);
                
                await using var stream = file.OpenReadStream(maxAllowedSize: 1024 * 1024 * 50); // 50MB limit
                await using var fs = new FileStream(filePath, FileMode.Create);
                await stream.CopyToAsync(fs);

                if (!string.IsNullOrWhiteSpace(ContentFilesRaw) && !ContentFilesRaw.EndsWith("\n"))
                {
                    ContentFilesRaw += "\n";
                }
                ContentFilesRaw += filePath;
                Logs.Add($"Selected and uploaded: {file.Name}");

                // Suggest defaults from the first file
                await UpdateDefaultsFromFileInfo(file, filePath);
            }
            catch (Exception ex)
            {
                Logs.Add($"Error uploading {file.Name}: {ex.Message}");
            }
        }
        StateHasChanged();
    }

    private async Task UpdateDefaultsFromFileInfo(IBrowserFile browserFile, string savedPath)
    {
        try
        {
            var (id, version) = await MetadataService.ExtractMetadataAsync(browserFile, savedPath);
            
            if (string.IsNullOrWhiteSpace(Metadata.Id))
            {
                Metadata.Id = id;
            }

            if (string.IsNullOrWhiteSpace(Metadata.Version))
            {
                Metadata.Version = version;
            }
        }
        catch (Exception ex)
        {
            Logs.Add($"Note: Could not extract detailed metadata: {ex.Message}");
        }
    }

    private async Task GenerateProject()
    {
        if (string.IsNullOrWhiteSpace(Metadata.Id))
        {
            Logs.Add("Error: Package ID is required.");
            return;
        }

        IsProcessing = true;
        try
        {
            UpdateMetadata();
            string tempDir = Path.Combine(Path.GetTempPath(), "NuGetTool", Metadata.Id);
            Directory.CreateDirectory(tempDir);

            string projectPath;
            if (IsNuspec)
            {
                projectPath = Path.Combine(tempDir, $"{Metadata.Id}.nuspec");
                PackageService.GenerateNuspec(Metadata, projectPath);
            }
            else
            {
                projectPath = Path.Combine(tempDir, $"{Metadata.Id}.csproj");
                PackageService.GenerateCsproj(Metadata, projectPath);
            }

            Logs.Add($"Project generated at: {projectPath}");
            
            await Task.Run(() => PackageService.BuildPackage(projectPath, IsNuspec));
            Logs.Add("Build process completed.");
        }
        catch (Exception ex)
        {
            Logs.Add($"Error during generation/build: {ex.Message}");
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private async Task UploadPackage()
    {
        if (string.IsNullOrWhiteSpace(Metadata.Id))
        {
            Logs.Add("Error: Package ID is required to locate the package.");
            return;
        }

        IsProcessing = true;
        try
        {
            // Save URL for next time
            try
            {
                await JS.InvokeVoidAsync("localStorage.setItem", "nuget-source-url", SourceUrl);
            }
            catch { }

            string tempDir = Path.Combine(Path.GetTempPath(), "NuGetTool", Metadata.Id);
            // Locate the .nupkg file matching the current version
            string expectedFileName = $"{Metadata.Id}.{Metadata.Version}.nupkg";
            var matchingFiles = Directory.Exists(tempDir) 
                ? Directory.GetFiles(tempDir, expectedFileName, SearchOption.AllDirectories) 
                : Array.Empty<string>();
            
            if (matchingFiles.Length == 0)
            {
                Logs.Add($"No .nupkg file found for version {Metadata.Version}. Expected: {expectedFileName}");
                // List all available .nupkg files in the directory
                if (Directory.Exists(tempDir))
                {
                    var availableFiles = Directory.GetFiles(tempDir, "*.nupkg", SearchOption.AllDirectories);
                    if (availableFiles.Length > 0)
                    {
                        Logs.Add("Available packages:");
                        foreach (var file in availableFiles)
                        {
                            Logs.Add($"  - {Path.GetFileName(file)}");
                        }
                    }
                    else
                    {
                        Logs.Add("No .nupkg files found in the temp directory. Please build the package first.");
                    }
                }
                else
                {
                    Logs.Add("Temp directory does not exist. Please build the package first.");
                }
                return;
            }

            string packagePath = matchingFiles[0];
            
            string? configContent = null;
            bool IsNugetOrg = SourceUrl.Contains("nuget.org", StringComparison.OrdinalIgnoreCase);
            string targetSource = SourceUrl;

            if (!IsNugetOrg)
            {
                Logs.Add($"Generating dynamic nuget.config for source: {PackageSourceKey}");
                configContent = PackageService.GetNuGetConfigContent(
                    PackageSourceKey, 
                    SourceUrl, 
                    UserName ?? "", 
                    Password ?? "");
                
                // If using a custom config, we use the Source Key as the target source name
                // so NuGet matches it to the credentials in the provided config file.
                targetSource = PackageSourceKey;
            }

            Logs.Add($"Uploading package: {packagePath} to {targetSource} (URL: {SourceUrl})");

            // Authentication selection: Use ApiKey if provided.
            // If ApiKey is empty, the command will rely on the provided nuget.config.
            await Task.Run(() => PackageService.UploadPackage(packagePath, IsNuspec, targetSource, ApiKey, configContent));
            Logs.Add("Upload process completed.");
        }
        catch (Exception ex)
        {
            Logs.Add($"Error during upload: {ex.Message}");
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private void UpdateMetadata()
    {
        Metadata.ContentFiles = ContentFilesRaw
            .Split('\n', StringSplitOptions.RemoveEmptyEntries)
            .Select(s => s.Trim())
            .ToList();
    }

    private void CancelOperation()
    {
        PackageService.CancelOperation();
    }

    public void Dispose()
    {
        PackageService.OnLog -= HandleLog;
    }
}
